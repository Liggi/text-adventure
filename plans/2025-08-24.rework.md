# Generative World State Rework - 2025-08-24

## Core Concept
Replace static world descriptions with narrator-generated canonical facts that accumulate over time. The narrator becomes the primary world-builder, establishing details that become permanent canon.

## Turn Flow Changes
```
Player Action → 
Narration (sees existing facts) → 
Canonical Fact Extraction (GPT-5-mini) → 
Mutations (can reference new facts) → 
World Events → 
NPC Turn → 
Back to Player
```

## World State Structure Changes

### Current Structure (constraining)
```go
type LocationInfo struct {
    Title       string
    Description string        // Static, limiting
    Items       []string      // Pre-defined list
    Exits       map[string]string
}
```

### New Structure (accumulating)
```go
type LocationInfo struct {
    Name        string              // "foyer", "study"
    Exits       map[string]string
    Facts       []string            // ["has tall windows", "dusty atmosphere"]
}

type ItemInfo struct {
    Name        string              // "silver_key", "oak_door"
    Facts       []string            // ["made of heavy oak", "creaks when moved"]
    Location    string
}

type NPCInfo struct {
    // ... existing fields
    Facts       []string            // ["wears glasses", "moves cautiously"]
    Memories    []string            // renamed from CoreMemories
}
```

### Minimal Default World State
Start with basic scaffolding - room names and exits only. No items, no descriptions.
```go
func NewDefaultWorldState() WorldState {
    return WorldState{
        Location:  "foyer",
        Inventory: []string{},
        Locations: map[string]LocationInfo{
            "foyer": {Name: "foyer", Facts: []string{}, Exits: map[string]string{"north": "study", "east": "library", "west": "kitchen"}},
            "study": {Name: "study", Facts: []string{}, Exits: map[string]string{"south": "foyer"}},
            "library": {Name: "library", Facts: []string{}, Exits: map[string]string{"west": "foyer"}},
            "kitchen": {Name: "kitchen", Facts: []string{}, Exits: map[string]string{"east": "foyer"}},
        },
        NPCs: map[string]NPCInfo{
            "elena": {
                Name:     "elena",
                Location: "library",
                Facts:    []string{},
                Personality: "cautious, observant, struggling with disorientation",
                Backstory: "recently awakened in this strange place with no memory of how she got here or who she was before",
                Memories: []string{
                    "woke up somewhere unfamiliar", 
                    "has no memory of her past",
                    "feeling disoriented and cautious"
                },
            },
        },
    }
}
```

## Narrator Prompt Changes

### New Collaborative Framing
```
You are the narrator for an LLM-powered narrative text game. This is collaborative 
story-building - your role is to create an engaging story for the player to enjoy.

You see "Established Facts" for locations, items, and characters. These are canonical 
details from previous narrations. Build naturally from these without contradicting them.

If the existing facts provide enough context for the current moment, work with what's 
established. You may add new details when the story naturally calls for them, but 
don't feel compelled to constantly expand descriptions.

Your descriptions become part of the permanent world canon. Focus on creating a good 
story experience - describe what changed this turn in 2-4 sentences.
```

## Canonical Fact Extraction

### Process
1. After narrator generates description, extract granular facts
2. Smart entity naming based on context (location + action)
3. Deduplication - ignore facts already in canon
4. Store facts against relevant entities

### Example
```
Narration: "The heavy oak door creaks as dust motes swirl in afternoon light"
Context: Player in "foyer", action was "open door"

Extract:
- Entity: foyer_door -> ["made of heavy oak", "creaks when opened"]  
- Entity: foyer -> ["has dust motes", "gets afternoon light"]

Deduplication: If "has dust motes" already exists in foyer facts, ignore it.
```

## Awakening Introduction Changes

### Player Introduction
Simple memory loss setup - player wakes up disoriented, memories hazy.

### Initial Awakening Sequence
Replace "initial look around" with awakening narration:
- Brief flavor about waking up
- Essentially equivalent to "look around" in foyer
- Let narrator establish initial canonical facts
- Don't mention Elena or force interactions

## Implementation Phases

### Phase 1: Core Structure
- [ ] Update WorldState structs to include Facts []string fields
- [ ] Rename CoreMemories to Memories for NPCs  
- [ ] Modify NewDefaultWorldState() to minimal scaffolding
- [ ] Update BuildWorldContext() to show established facts

### Phase 2: Fact Extraction
- [ ] Create fact extraction LLM call after narration
- [ ] Implement smart entity naming and deduplication
- [ ] Insert into turn flow (after narration, before mutations)

### Phase 3: Integration  
- [ ] Update narrator prompt with collaborative framing
- [ ] Replace initial look around with awakening sequence
- [ ] Ensure mutations can reference newly-established facts
- [ ] Test end-to-end flow

## Benefits
- **No more item anchoring** - narrator builds organically instead of listing pre-defined items
- **Rich descriptions emerge naturally** - collaborative story-building motivation  
- **Consistent world-building** - canonical facts prevent contradictions
- **Balanced expansion** - narrator can work with existing facts without over-building
- **Narrative coherence** - memory loss creates natural exploration motivation